{
  "metadata": {
       "templateName": "Export DynamoDB table to S3 (Updated L)",
       "templateDescription": "This template schedules an Amazon Elastic MapReduce (EMR) cluster to export data from a DynamoDB table to an Amazon S3 folder. The files are stored in timestamped subfolders in the DynamoDB export format on each scheduled execution."
    },
  "objects": [
    {
      "startAt": "FIRST_ACTIVATION_DATE_TIME",
      "name": "DailySchedule",
      "id": "DailySchedule",
      "period": "1 day",
      "type": "Schedule"
    },
    {
      "id": "Default",
      "name": "Default",
      "scheduleType": "CRON",
      "schedule": {
        "ref": "DailySchedule"
      },
      "failureAndRerunMode": "CASCADE",
      "role": "DataPipelineDefaultRole",
      "resourceRole": "DataPipelineDefaultResourceRole"
    },
    {
      "id": "EmrClusterForBackup",
      "name":"EmrClusterForBackup",
      "amiVersion": "3.8.0",
      "masterInstanceType":"m3.xlarge",
      "coreInstanceType":"m3.xlarge",
      "coreInstanceCount":"1",
      "type": "EmrCluster",
      "bootstrapAction" : ["s3://elasticmapreduce/bootstrap-actions/configure-hadoop, --yarn-key-value, yarn.nodemanager.resource.memory-mb=12800,--yarn-key-value,yarn.scheduler.minimum-allocation-mb=256,--mapred-key-value,mapreduce.map.memory.mb=500,--mapred-key-value,mapreduce.map.java.opts=-Xmx400M,--mapred-key-value,mapreduce.job.reduce.slowstart.completedmaps=1,--mapred-key-value,mapreduce.map.speculative=false"],
      "terminateAfter":"2 hours"
    },
    {
      "id": "EmrClusterResizeActivity",
      "name": "EmrClusterResizeActivity",
      "runsOn": {
        "ref": "EmrClusterForBackup"
      },
      "maximumRetries": "0",
      "attemptTimeout": "8 hours",
      "type": "EmrActivity",
      "step": [
         "s3://elasticmapreduce/libs/script-runner/script-runner.jar,s3://datapipeline-us-east-1/sample-scripts/resize.sh,-t=#{myDDBTableName},-r=#{myDDBReadThroughputRatio},-p=export"
        ]
    },
    {
        "id":"TableBackupActivity",
        "name":"TableBackupActivity",
        "runsOn":{
            "ref":"EmrClusterForBackup"
        },
        "dependsOn" : { "ref" : "EmrClusterResizeActivity" },
        "type": "EmrActivity",
        "maximumRetries": "2",
        "step": [
           "#{myPathToDynamoDBBackupJar},org.apache.hadoop.dynamodb.tools.DynamoDbExport,#{myOutputS3Loc}/#{format(@scheduledStartTime, 'YYYY-MM-dd-HH-mm-ss')},#{myDDBTableName},#{myDDBReadThroughputRatio}"
        ]   
    }
  ],
  "parameters":[
    {
      "id":"myPathToDynamoDBBackupJar",
      "type":"String",
      "description":"Path to the DynamoDB EMR Handler",
      "default":"s3://dynamodb-emr-us-east-1/emr-ddb-storage-handler/latest/emr-ddb.jar",
      "watermark":"s3://mybucket/path/to/ddbjarbacupfile/"
    },
    {
		"id":"myDDBTableName",
		"type":"String",
		"description":"DynamoDB table name"
	 },
	 {
		"id":"myDDBReadThroughputRatio",
		"type":"Double",
		"description":"DynamoDB read throughput ratio",
		"default":"0.2",
		"watermark":"Enter value between 0.1-1.0"
	 },
	 {
		"id":"myOutputS3Loc",
		"type":"AWS::S3::ObjectKey",
		"description":"Output S3 folder"
	 }
  ],
  "values" : {
    "myPathToDynamoDBBackupJar": "s3://dynamodb-emr-us-east-1/emr-ddb-storage-handler/latest/emr-ddb.jar"
  }
}