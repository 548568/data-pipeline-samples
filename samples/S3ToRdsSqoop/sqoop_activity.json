{
  "objects": [
    {
      "myComment": "The default object sets global properties for the pipeline.",
      "id": "Default",
      "name": "Default",
      "failureAndRerunMode": "CASCADE",
      "resourceRole": "DataPipelineDefaultResourceRole",
      "role": "DataPipelineDefaultRole",
      "pipelineLogUri": "#{myPipelineLogUri}",
      "scheduleType": "ONDEMAND"
    },
    {
      "myComment": "An EMR cluster where the Sqoop job will be run. These parameters can be edited to create a more powerful cluster.",
      "id": "MyEmrCluster",
      "name": "MyEmrCluster",
      "type": "EmrCluster",
      "masterInstanceType": "#{myEmrMasterInstanceType}",
      "coreInstanceType": "#{myEmrCoreInstanceType}",
      "coreInstanceCount": "#{myEmrCoreInstanceCount}",
      "releaseLabel": "emr-5.0.0",
      "applications": ["sqoop"],
      "terminateAfter": "12 hours"
    },
    {
      "myComment": "S3 folder where the input CSV is stored.",
      "id": "S3InputDataLocation",
      "name": "S3InputDataLocation",
      "directoryPath": "#{myS3InputDataLocation}",
      "type": "S3DataNode"
    },
    {
      "myComment": "The shell command to invoke sqoop to copy the CSV into RDS. This template assumes that the target database is either MySQL or MariaDB and that the target table has already been created.",
      "id": "SqoopActivity",
      "name": "SqoopActivity",
      "runsOn": {
        "ref": "MyEmrCluster"
      },
      "input": {
        "ref": "S3InputDataLocation"
      },
      "type": "ShellCommandActivity",
      "command": "sqoop export --connect jdbc:mariadb://#{myRdsEndpoint}/#{myRdsDatabaseName} --driver org.mariadb.jdbc.Driver --table #{myRdsTableName} --username #{myRdsUsername} --password #{*myRdsPassword} --export-dir #{myS3InputDataLocation}"
    }
  ],
  "parameters": [
    {
      "id": "myEmrMasterInstanceType",
      "type": "String",
      "default": "m2.xlarge",
      "description": "The EC2 instance type to use for the master node in the EMR cluster"
    },
    {
      "id": "myEmrCoreInstanceType",
      "type": "String",
      "default": "m2.xlarge",
      "description": "The EC2 instance type to use for the core nodes in the EMR cluster"
    },
    {
      "id": "myEmrCoreInstanceCount",
      "type": "String",
      "default": "2",
      "description": "The number of core nodes to launch in the EMR cluster"
    },
    {
      "id": "myRdsEndpoint",
      "type": "String",
      "description": "DNS endpoint for target RDS instance. The value should include the port number. Example: test.xyzw.us-east-1.rds.amazonaws.com:3306"
    },
    {
      "id": "myRdsDatabaseName",
      "type": "String",
      "description": "Name of the target MySQL or MariaDB database"
    },
    {
      "id": "myRdsTableName",
      "type": "String",
      "description": "Name of the database table that the CSV will be imported into"
    },
    {
      "id": "myRdsUsername",
      "type": "String",
      "description": "User name to use to connect to RDS"
    },
    {
      "id": "*myRdsPassword",
      "type": "String",
      "description": "Password to use to connect to RDS"
    },
    {
      "id": "myS3InputDataLocation",
      "type": "AWS::S3::ObjectKey",
      "description": "S3 path to folder where the CSV data is stored"
    },
    {
      "id": "myPipelineLogUri",
      "type": "AWS::S3::ObjectKey",
      "description": "S3 folder where log data generated by this pipeline will be written"
    }
  ]
}
